#!/bin/bash -e

[ -z "$DEBUG" ] || set -x

CONFIG_PATH=/var/vcap/jobs/webhooks/config
HOST_PATH="https://<%= link('service-fabrik-apiserver').p('ip') %>:<%= link('service-fabrik-apiserver').p("port") %>/apis/admissionregistration.k8s.io/v1beta1/mutatingwebhookconfigurations"

echo "Trying to update the webhook configuration"

RESPONSE=$(curl -sk --header "Content-Type: application/merge-patch+json" --cert $CONFIG_PATH/client-cert.pem --key $CONFIG_PATH/client-key.pem "${HOST_PATH}/manager-webhooks" -X PATCH --data "@$CONFIG_PATH/webhooks.json")

RESPONSE_CODE=$(echo $RESPONSE | /var/vcap/packages/jq/bin/jq -r .'code')
echo "Response code of the patch is $RESPONSE_CODE"

if [[ "$RESPONSE_CODE" == "404" ]]; then
   echo "creating the webhook"
   curl -sk --header "Content-Type: application/json" --cert $CONFIG_PATH/client-cert.pem --key $CONFIG_PATH/client-key.pem "${HOST_PATH}" -X POST --data "@$CONFIG_PATH/webhooks.json"
fi



echo "Trying to update the metering webhook configuration"

RESPONSE=$(curl                                                     \
    -sk                                                             \
    --header "Content-Type: application/merge-patch+json"           \
    --cert $CONFIG_PATH/client-cert.pem                             \
    --key $CONFIG_PATH/client-key.pem "${HOST_PATH}/meter-webhooks" \
    -X PATCH                                                        \
    --data "@$CONFIG_PATH/metering_webhooks.json")

RESPONSE_CODE=$(echo $RESPONSE | /var/vcap/packages/jq/bin/jq -r .'code')
echo "Response code of the patch is $RESPONSE_CODE"

if [[ "$RESPONSE_CODE" == "404" ]]; then
   echo "creating the metering webhook"
   curl                                             \
   -sk                                              \
   --header "Content-Type: application/json"        \
   --cert $CONFIG_PATH/client-cert.pem              \
   --key $CONFIG_PATH/client-key.pem "${HOST_PATH}" \
   -X POST                                          \
   --data "@$CONFIG_PATH/metering_webhooks.json"
fi
