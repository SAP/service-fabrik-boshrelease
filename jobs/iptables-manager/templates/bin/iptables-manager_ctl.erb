#!/bin/bash

set -e

export JOB_NAME='iptables-manager'
export HOME=/var/vcap
export LOG_DIR=$HOME/sys/log/$JOB_NAME
export RUN_DIR=$HOME/sys/run/$JOB_NAME
export JOB_DIR=$HOME/jobs/$JOB_NAME

for dir in $LOG_DIR $RUN_DIR
do
  mkdir -p ${dir}
  chown vcap:vcap ${dir}
  chmod 775 ${dir}
done

export PID_FILE=${RUN_DIR}/iptables-manager.pid

exec 1>> $LOG_DIR/$JOB_NAME.stdout.log
exec 2>> $LOG_DIR/$JOB_NAME.stderr.log

export RUN_AS_USER=vcap

case $1 in
  start)
    setcap CAP_NET_RAW,CAP_NET_ADMIN=ei /sbin/xtables-multi
    capsh --keep=1 --user=${RUN_AS_USER} --caps="cap_net_admin,cap_net_raw+eip" -- -c '$JOB_DIR/bin/clear-iptables' #Flush all existing rules
    capsh --keep=1 --user=${RUN_AS_USER} --caps="cap_net_admin,cap_net_raw+eip" -- -c '$JOB_DIR/bin/update-iptables'
    setcap -r /sbin/xtables-multi
    echo 1 >> $PID_FILE
    ;;
  stop)
    setcap CAP_NET_RAW,CAP_NET_ADMIN=ei /sbin/xtables-multi
    capsh --keep=1 --user=${RUN_AS_USER} --caps="cap_net_admin,cap_net_raw+eip" -- -c '$JOB_DIR/bin/clear-iptables'
    setcap -r /sbin/xtables-multi
    rm -f $PID_FILE
    ;;

esac
exit 0